#!/usr/bin/env sh
#
# builds and uploads a distribution to pypi
#

pypi="https://upload.pypi.org/legacy/"
pypi_test="https://test.pypi.org/legacy/"

case $1 in
  pypi)
    publish_url="$pypi"
    ;;
  test)
    publish_url="$pypi_test"
    ;;
  *)
    publish_url="$pypi_test"
    dry_run="--dry-run"
    ;;
esac

set -o nounset

if [ "$publish_url" = "pypi_test" ]; then
  export UV_PUBLISH_PASSWORD="$TWINE_TEST_PASSWORD"
fi

if [ -n "$TWINE_PASSWORD" ] ; then
  export UV_PUBLISH_USERNAME="$TWINE_USERNAME"
else
  echo "TWINE_PASSWORD must be set." 1>&2
  exit 1
fi

if uv build ; then
  uv publish "${dry_run:-}" --publish-url "$publish_url"
fi
