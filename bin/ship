#!/usr/bin/env sh
#
# builds and uploads a distribution to pypi
#

pypi="https://upload.pypi.org/legacy/"
pypi_test="https://test.pypi.org/legacy/"

set -o nounset
set +x

export UV_REQUIRE_HASHES=1
export UV_NO_CONFIG=1
export UV_PYTHON_DOWNLOADS="never"
unset UV_INSECURE_HOST

if uv build --clear --no-create-gitignore ; then
    case ${1:-foo} in
    pypi)
        uv publish --username "$UV_PUBLISH_USERNAME" --password "$UV_PUBLISH_PASSWORD" --publish-url "$pypi"
        ;;
    test)
        uv publish --username "$UV_PUBLISH_TEST_USERNAME" --password "$UV_PUBLISH_TEST_PASSWORD" --publish-url "$pypi_test"
        ;;
    *)
        uv publish --dry-run --username "$UV_PUBLISH_TEST_USERNAME" --password "$UV_PUBLISH_TEST_PASSWORD" --publish-url "$pypi_test"
        ;;
    esac
fi
